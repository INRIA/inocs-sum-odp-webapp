---
import Layout from "../../layouts/Layout.astro";
import { LivingLabKPIsEdition, InfoAlert } from "../../components/react";
import ApiClient from "../../lib/api-client/ApiClient";

const labId = Astro.locals.livingLab?.id;
if (!labId) {
  return Astro.redirect(getUrl("/lab-admin/set-lab"));
}
const api = new ApiClient(Astro.request);

const kpis = (await api.getKPIs({})) || [];
const modalSplitKpi = kpis.find((kpi) => kpi.kpi_number === "15");
const filteredKpis = kpis.filter(
  (kpi) =>
    kpi.id !== modalSplitKpi?.id && kpi.parent_kpi_id !== modalSplitKpi?.id
);
const livingLabData = await api.getLivingLab(labId);
const categories = await api.getCategories("KPI_SIEF");

const modalSplitResults = livingLabData?.kpi_results?.filter((result) =>
  filteredKpis?.some((mk) => mk.id === result.kpidefinition_id)
);

const valueBeforeDate = modalSplitResults?.reduce(
  (minDate, result) => {
    const dateStr = result.result_before?.date;
    if (dateStr) {
      const date = new Date(dateStr);
      if (!minDate || date < minDate) {
        return date;
      }
    }
    return minDate;
  },
  null as Date | null
);

const valueAfterDate = modalSplitResults?.reduce(
  (maxDate, result) => {
    const dateStr = result.result_after?.date;
    if (dateStr) {
      const date = new Date(dateStr);
      if (!maxDate || date > maxDate) {
        return date;
      }
    }
    return maxDate;
  },
  null as Date | null
);
---

<Layout role="editor">
  <div class="mx-auto px-4 py-8 flex flex-col gap-8">
    <h2>Share your Key Performance Indicators - KPI</h2>

    <InfoAlert
      title="How to calculate KPI values?"
      icon="question"
      variant="success"
      actionText="KPIs template"
      actionHref={"/files/SIEF_All_KPIs-template.xlsx"}
    >
      <div class="text-sm text-gray-700 space-y-4">
        <p class="font-medium">
          Your contribution is essential to identify the impacts of New Shared
          Mobility measures across Europe.
        </p>

        <ol class="list-decimal list-inside space-y-2">
          <li>
            <strong>Review the SIEF (Deliverable D1.2)</strong> — identify the data
            you need and define a data collection plan for your city. <a
              href="/files/SUM_D1.2_KPI Review_V1.0_FINAL.pdf"
              class="text-blue-800 hover:underline"
              >Download SUM_D1.2_KPI Review_V1.0_FINAL.pdf</a
            >.
          </li>
          <li>
            <strong>Compute KPI values from your data</strong> — use the KPI template
            spreadsheet to calculate the values. <a
              href="/files/SIEF_All_KPIs-template.xlsx"
              class="text-blue-800 hover:underline"
              >Download SUM D1.2 SIEF_All_KPIs-template</a
            >.
          </li>
          <li>
            <strong>Submit your KPI values</strong> — add the computed KPI values
            to the SUM Open Data Platform so they can feed analyses and comparisons.
          </li>
        </ol>

        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
          <li>
            If a New Shared Mobility service was introduced after the baseline
            period, record it as <strong>0%</strong>
            for the "before" measurement.
          </li>
        </ul>
      </div>
    </InfoAlert>

    <LivingLabKPIsEdition
      categories={categories || []}
      kpis={filteredKpis}
      livingLabId={labId}
      kpiResults={livingLabData?.kpi_results || []}
      valueAfterDate={valueAfterDate
        ? valueAfterDate.toISOString().slice(0, 10)
        : undefined}
      valueBeforeDate={valueBeforeDate
        ? valueBeforeDate.toISOString().slice(0, 10)
        : undefined}
      client:load
    />
  </div>
</Layout>
