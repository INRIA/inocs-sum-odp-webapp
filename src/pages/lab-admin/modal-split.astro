---
import Layout from "../../layouts/Layout.astro";
import { InfoAlert, LivingLabModalSplit } from "../../components/react";
import ApiClient from "../../lib/api-client/ApiClient";
const labId = Astro.locals.livingLab?.id;
if (!labId) {
  return Astro.redirect(getUrl("/lab-admin/set-lab"));
}
const api = new ApiClient(Astro.request);

const transportModes = await api.getTransportModes();
const modalSplitKpis = (await api.getKPIs({ kpi_number: "15" }))?.filter(
  (kpi) => kpi.parent_kpi_id
);
const livingLabData = await api.getLivingLab(labId);
const modalSplitResults = livingLabData?.kpi_results?.filter((result) =>
  modalSplitKpis?.some((mk) => mk.id === result.kpidefinition_id)
);

const valueBeforeDate = modalSplitResults?.reduce(
  (minDate, result) => {
    const dateStr = result.result_before?.date;
    if (dateStr) {
      const date = new Date(dateStr);
      if (!minDate || date < minDate) {
        return date;
      }
    }
    return minDate;
  },
  null as Date | null
);

const valueAfterDate = modalSplitResults?.reduce(
  (maxDate, result) => {
    const dateStr = result.result_after?.date;
    if (dateStr) {
      const date = new Date(dateStr);
      if (!maxDate || date > maxDate) {
        return date;
      }
    }
    return maxDate;
  },
  null as Date | null
);
---

<Layout role="editor">
  <div class="mx-auto px-4 py-8 flex flex-col gap-8">
    <h2 class="text-2xl font-bold mb-4">Modal split KPI</h2>

    <InfoAlert
      title="Why are transport modes status important?"
      icon="question"
      variant="info"
    >
      <small
        >This page collects modal split for all transport modes.<br />
        The status of the transport mode provides insights about the scheduled changes
        on the transport network within the Living Lab.<br />
        <i
          >If there is a New Shared Mobility Service introduced, please record
          with 0% at the before implementation phase.</i
        >
      </small>
    </InfoAlert>

    <InfoAlert
      title="How to calculate Modal Split KPI values?"
      icon="question"
      variant="success"
      actionText="Modal Split KPI template"
      actionHref={"/files/SIEF_Modal_Split_KPI-template.xlsx"}
    >
      <div class="text-sm text-gray-700 space-y-4">
        <p class="font-medium">
          Your contribution is essential to identify the impacts of New Shared
          Mobility measures across Europe.
        </p>

        <ol class="list-decimal list-inside space-y-2">
          <li>
            <strong>Review the SIEF (Deliverable D1.2)</strong> — identify the data
            you need and define a data collection plan for your city. <a
              href="/files/SUM_D1.2_KPI Review_V1.0_FINAL.pdf"
              class="text-blue-800 hover:underline"
              >Download SUM_D1.2_KPI Review_V1.0_FINAL.pdf</a
            >.
          </li>
          <li>
            <strong>Compute KPI values from your data</strong> — use the Modal Split
            KPI template spreadsheet to calculate the values. <a
              href="/files/SIEF_Modal_Split_KPI-template.xlsx"
              class="text-blue-800 hover:underline"
              >Download SIEF_Modal_Split_KPI-template</a
            >.
          </li>
          <li>
            <strong>Submit your KPI values</strong> — add the computed KPI values
            to the SUM Open Data Platform so they can feed analyses and comparisons.
          </li>
        </ol>

        <small>
          If a New Shared Mobility service was introduced after the baseline
          period, record it as <strong>0%</strong>
          for the "before" measurement.
        </small>
      </div>
    </InfoAlert>
  </div>

  <LivingLabModalSplit
    modes={transportModes ?? []}
    kpis={modalSplitKpis ?? []}
    livingLabId={labId}
    livingLabTransportModes={livingLabData?.transport_mode_living_lab_implementation ||
      []}
    kpiResults={modalSplitResults ?? []}
    valueAfterDate={valueAfterDate
      ? valueAfterDate.toISOString().slice(0, 10)
      : undefined}
    valueBeforeDate={valueBeforeDate
      ? valueBeforeDate.toISOString().slice(0, 10)
      : undefined}
    client:load
  />
</Layout>
